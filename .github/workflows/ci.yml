name: CI/CD Pipeline

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

jobs:
  test-backend:
    runs-on: ubuntu-latest
    continue-on-error: true

    steps:
    - uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
        cache-dependency-path: backend/package-lock.json

    - name: Install backend dependencies
      run: |
        cd backend
        npm ci

    - name: Run backend tests
      run: |
        cd backend
        npm test

    - name: Check backend test coverage
      run: |
        cd backend
        npm run test:coverage

  test-android:
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v4

    - name: Set up JDK 17
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'

    - name: Setup Android SDK
      uses: android-actions/setup-android@v3

    - name: Cache Gradle packages
      uses: actions/cache@v4
      with:
        path: |
          ~/.gradle/caches
          ~/.gradle/wrapper
        key: ${{ runner.os }}-gradle-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties') }}
        restore-keys: |
          ${{ runner.os }}-gradle-

    - name: Make gradlew executable
      run: chmod +x ./gradlew

    - name: Run Android unit tests
      run: ./gradlew testDebugUnitTest

    - name: Run Android instrumentation tests
      uses: reactivecircus/android-emulator-runner@v2
      with:
        api-level: 29
        script: ./gradlew connectedDebugAndroidTest

  build-android:
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    needs: []
    continue-on-error: true

    steps:
    - uses: actions/checkout@v4

    - name: Set up JDK 17
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'

    - name: Setup Android SDK
      uses: android-actions/setup-android@v3

    - name: Cache Gradle packages
      uses: actions/cache@v4
      with:
        path: |
          ~/.gradle/caches
          ~/.gradle/wrapper
        key: ${{ runner.os }}-gradle-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties') }}
        restore-keys: |
          ${{ runner.os }}-gradle-

    - name: Make gradlew executable
      run: chmod +x ./gradlew

    - name: Build Android APK
      run: ./gradlew assembleRelease

    - name: Upload APK artifacts
      uses: actions/upload-artifact@v4
      with:
        name: app-release
        path: app/build/outputs/apk/release/*.apk

  distribute-android:
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    needs: [build-android]

    steps:
    - uses: actions/checkout@v4

    - name: Download APK artifact
      uses: actions/download-artifact@v4
      with:
        name: app-release
        path: app/build/outputs/apk/release/

    - name: Distribute to Firebase App Distribution
      uses: wzieba/Firebase-Distribution-Github-Action@v1
      with:
        appId: "1:215828472999:android:aa953679adf35f55cf2782"
        serviceCredentialsFileContent: ${{ secrets.FIREBASE_SERVICE_ACCOUNT_KEY }}
        groups: testers
        file: app/build/outputs/apk/release/app-release.apk
        releaseNotes: "Automated build from GitHub Actions - ${{ github.run_number }}"

  deploy-backend:
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    needs: []

    steps:
    - uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
        cache-dependency-path: backend/package-lock.json

    - name: Install backend dependencies
      run: |
        cd backend
        npm ci

    - name: Build backend
      run: |
        cd backend
        npm run build

    - name: Authenticate to Google Cloud
      uses: google-github-actions/auth@v2
      with:
        credentials_json: ${{ secrets.GCP_SA_KEY }}

    - name: Set up Cloud SDK
      uses: google-github-actions/setup-gcloud@v2

    - name: Configure Docker
      run: gcloud auth configure-docker us-central1-docker.pkg.dev

    - name: Build and push Docker image
      run: |
        cd backend
        docker build -t us-central1-docker.pkg.dev/startsmart-8789e/chat-app-repo/chat-backend:latest .
        docker push us-central1-docker.pkg.dev/startsmart-8789e/chat-app-repo/chat-backend:latest

    - name: Deploy to Cloud Run
      run: |
        # Try to update existing service, if it fails, create new one
        if gcloud run services describe chat-backend --region=us-central1 --format="value(status.url)" >/dev/null 2>&1; then
          echo "Updating existing Cloud Run service..."
          gcloud run deploy chat-backend \
            --image=us-central1-docker.pkg.dev/startsmart-8789e/chat-app-repo/chat-backend:latest \
            --region=us-central1 \
            --update-env-vars="NODE_ENV=production,FIREBASE_PROJECT_ID=startsmart-8789e"
        else
          echo "Creating new Cloud Run service..."
          gcloud run deploy chat-backend \
            --image=us-central1-docker.pkg.dev/startsmart-8789e/chat-app-repo/chat-backend:latest \
            --platform=managed \
            --region=us-central1 \
            --allow-unauthenticated \
            --port=8080 \
            --memory=1Gi \
            --cpu=1 \
            --max-instances=10 \
            --min-instances=1 \
            --concurrency=80 \
            --timeout=300 \
            --set-env-vars="NODE_ENV=production,FIREBASE_PROJECT_ID=startsmart-8789e"
        fi
